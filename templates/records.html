# at top make sure you have:
from flask import Flask, request, redirect, url_for, render_template_string, send_file

@app.route("/records")
def records_screen():
    # sanitize ?last=... from the query string
    try:
        last = int(request.args.get("last", "7"))
    except ValueError:
        last = 7
    last = max(1, min(last, 90))

    prev_last = max(1, last - 3)
    next_last = min(90, last + 3)

    dates = get_last_n_dates(last)
    dates, rows = build_pivot_for_dates(dates)
    return render_template_string(
        TPL_RECORDS,
        dates=dates, rows=rows, last=last,
        prev_last=prev_last, next_last=next_last
    )
